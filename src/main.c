/*
 *	(C) 2022 J. R. Sharp	
 *
 *	Released under MIT License
 *
 *	See LICENSE.txt for License Terms
 *
 *	main.c : Program entry point
 *
 */

#include <avr/io.h>

#define BLINK_DELAY_MS 1000

#include <util/delay.h>

#include "uart.h"
#include "debug.h"
#include "gpio.h"
#include "lcd.h"
#include "adc.h"

#include <avr/pgmspace.h>

#define LED_PORT GPIO_PORTB
#define LED_PIN	 5

//	hi = (r&0xf8) | (g >> 5);
//	lo = (g << 5) | (b >> 3); 	

#define MK_COLOR(r,g,b) ((((r&0xf8) | g >> 5)<<8) | (g << 5) | (b >> 3))
#define COL_RED MK_COLOR(0xff, 0, 0)
#define COL_GREEN MK_COLOR(0, 0xff, 0)
#define COL_BLUE MK_COLOR(0, 0, 0xff)
#define COL_GREY MK_COLOR(65, 65, 65)
#define COL_WHITE MK_COLOR(0xff, 0xff, 0xff)
#define COL_BLACK MK_COLOR(0, 0, 0)


const uint8_t bitmap[] PROGMEM = {
0x03,0xFF,0xF8,0x00,0xFF,0xFF,0x80,0x3F,0xFF,0xF8,0x03,0xFF,0xFE,0xC3,0x3F,0xFF,
0xBC,0xF0,0x00,0x0F,0xFF,0x00,0x01,0xFF,0xE0,0x00,0x3F,0xFC,0x00,0x07,0xFF,0x80,
0x00,0xFF,0xF0,0x00,0x1F,0xFE,0x00,0x03,0xFF,0xC0,0x00,0x7F,0xF8,0x00,0x0F,0xFF,
0x00,0x01,0xFF,0xE0,0x00,0x3F,0xFC,0x00,0x07,0xFF,0x80,0x00,0xFF,0xF0,0x00,0x1F,
0xFC,0x00,0x00,0xFE,0x00,0x00,0x07,0x00,0x00,0x00,0x40,0x00,0x00,0x04,0x00,0x00,
0x00,0xE0,0x00,0x00,0x7F,0x00,0x00,0x3F,0xF0,0x00,0x1F,0xFE,0x00,0x03,0xFF,0xC0,
0x00,0x7F,0xF8,0x00,0x0F,0xFF,0x00,0x01,0xFF,0xE0,0x00,0x3F,0xFC,0x00,0x07,0xFF,
0x80,0x00,0xFF,0xF0,0x00,0x1F,0xFE,0x00,0x03,0xFF,0xC0,0x00,0x7F,0xF8,0x00,0x0F,
0xFF,0x00,0x01,0xFF,0xE0,0x00,0x3F,0x78,0x00,0x03,0xC6,0x7F,0xFF,0x30,0x1F,0xFF,
0xF0,0x07,0xFF,0xFF,0x00,0x7F,0xFF,0xC0,0x07,0xFF,0xF0,0x00,
}; 

int main (void)
{
	gpio_set_output(LED_PORT, LED_PIN);

	uart_initialize();

	DEBUG("Hello world! LCD ID = %x\n", lcd_read_id());

	lcd_init();
	
	lcd_clear(COL_WHITE);
	lcd_fill_rect(20, 20, 200, 280, COL_RED);

	lcd_draw_bitmap(120 - 20 - 4, 160 - 4, 27, 46, COL_BLACK, COL_RED, bitmap);
	
	while(1) 
	{

		uint16_t x, y, z;

		ts_read(&x, &y, &z);

		DEBUG("TS x = %d, y = %d, z = %d\n", x, y, z);
		
		// turn LED on
		gpio_set(LED_PORT, LED_PIN);
		_delay_ms(BLINK_DELAY_MS);

		// turn LED off
		gpio_clear(LED_PORT, LED_PIN);
		_delay_ms(BLINK_DELAY_MS);
	}
}
